@vmdl;

# Creates a new Habitat instance.
@new habitat;

# Creates a new network.
@in habitat
@new module
@open;

# Create a new VirtualBox controller inside this network.
@in habitat/module
@new vbox;

# Create a new machine of this VirtualBox controller.
@in habitat/module/vbox
@new machine
@as dns-server ubuntu linux machine $uuid
@is @json {
    "template": "ubnt-temp-1",
    "security": "$root"
} @end
@has {
    @new payload
    @as bind9-payload payload;
    
    @new payload
    @as amplification-attack-bind9-payload vulnerability optional-payload payload
    @is @json {
        "if": "security",
        "op": "lt",
        "val": "0.4"
    } @end;
};

# Give a default payload to all (already declared) Linux-based machines.
@in habitat @to linux machine
@new payload
@as default-linux-payload
@close;

# Huge context expression for the sake of it.
@in habitat @into !!!((1 @into 2 @to 3 @or 4 @and 5) @or (1 : 2 . 3 | 4 & 5)) @to vbox @to (linux machine) @or (windows (machine @or container) @and @not freebsd @not @not @not ((openbsd)))
@get;

# New machine with nothing.
@in habitat/module/vbox
@new machine
@as @none
@is @none
@has @none;

# Finalizing everything so it can no longer be modified/is hidden to the compositor.
@in habitat/**
@done;

# Print everything.
@in habitat
@get;
